<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ“… AI ì¼ì • ë„ìš°ë¯¸</title>
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
    {% include "includes/header.html" %}
  

  <main class="max-w-7xl mx-auto px-4 py-6">
    <!-- ìº˜ë¦°ë” ì„¹ì…˜ -->
    <section class="bg-white rounded-xl shadow p-6 mb-6">
      <h2 class="text-xl font-bold mb-4">ğŸ“… ë‚´ ì¼ì • ìº˜ë¦°ë”</h2>
      <div id="calendar" class="w-full"></div>
    </section>

    <!-- ì˜¤ëŠ˜ì˜ ì¼ì • ìš”ì•½ ì„¹ì…˜ -->
    <section class="bg-white rounded-xl shadow p-6">
      <h2 class="text-xl font-bold mb-4">ğŸ“Œ ì˜¤ëŠ˜ì˜ ì¼ì •</h2>
      <div id="today-schedules-container">
        <!-- ì˜¤ëŠ˜ì˜ ì¼ì •ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ë¡œë“œë©ë‹ˆë‹¤ -->
        <div class="flex justify-center py-5">
          <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div>
        </div>
      </div>
    </section>
  </main>
  
  <!-- ì¼ì • ìƒì„¸ ëª¨ë‹¬ (dashboard.htmlê³¼ ë™ì¼) -->
  <div id="detailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex justify-center items-center z-30">
    <div class="bg-white rounded-xl shadow p-6 w-96">
      <h3 class="text-lg font-semibold mb-4">ğŸ“‹ ì¼ì • ìƒì„¸</h3>
      <div class="space-y-2 mb-4 text-sm text-gray-700">
        <p><strong>ì œëª©:</strong> <span id="detailTitle"></span></p>
        <p><strong>ì‹œê°„:</strong> <span id="detailTime"></span></p>
        <p><strong>ì„¤ëª…:</strong> <span id="detailDesc"></span></p>
        <p><strong>ìš°ì„ ìˆœìœ„:</strong> <span id="detailPriority"></span></p>
        <p><strong>ì™„ë£Œ ì—¬ë¶€:</strong> <span id="detailCompleted"></span></p>
      </div>
      <div class="flex justify-end gap-2">
        <button id="completeBtn" class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600">ì™„ë£Œ</button>
        <button id="deleteBtn" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600">ì‚­ì œ</button>
        <button id="closeDetailBtn" class="px-3 py-1 bg-gray-300 rounded hover:bg-gray-400">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/js/main.js"></script>
   <script src="/static/js/common.js"></script>
  <script>
    // ì¸ì¦ í™•ì¸
    document.addEventListener('DOMContentLoaded', function() {
      if (!getToken()) {
        window.location.href = '/login';
        return;
      }
      
      // ìº˜ë¦°ë” ì´ˆê¸°í™”
      initCalendar();
      
      // ì˜¤ëŠ˜ì˜ ì¼ì • ë¡œë“œ
      loadTodaySchedules();
      
      // ë¡œê·¸ì•„ì›ƒ ë§í¬ ì´ë²¤íŠ¸
      document.getElementById('logout-link').addEventListener('click', function(e) {
        e.preventDefault();
        localStorage.removeItem('token');
        window.location.href = '/login';
      });
      
      // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
      document.getElementById('closeDetailBtn').addEventListener('click', function() {
        document.getElementById('detailModal').classList.add('hidden');
      });
      
      // ì¼ì • ì‚­ì œ ë²„íŠ¼
      document.getElementById('deleteBtn').addEventListener('click', function() {
        const scheduleId = this.dataset.id;
        if (confirm('ì •ë§ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
          deleteSchedule(scheduleId);
        }
      });
      
      // ì¼ì • ì™„ë£Œ ë²„íŠ¼
      document.getElementById('completeBtn').addEventListener('click', function() {
        const scheduleId = this.dataset.id;
        toggleScheduleComplete(scheduleId, true);
      });
    });
    
    // ìº˜ë¦°ë” ì´ˆê¸°í™” í•¨ìˆ˜ (dashboard.htmlê³¼ ë™ì¼)
    function initCalendar() {
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        locale: 'ko',
        height: 500,
        events: function(fetchInfo, successCallback, failureCallback) {
          // ì„œë²„ì—ì„œ ì¼ì • ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
          fetchAPI('/api/schedules')
            .then(schedules => {
              const events = schedules.map(schedule => {
                return {
                  id: schedule.id,
                  title: schedule.title,
                  start: schedule.start_time,
                  end: schedule.end_time,
                  description: schedule.description,
                  priority: schedule.priority,
                  is_completed: schedule.is_completed,
                  color: getPriorityColor(schedule.priority),
                  textColor: schedule.is_completed ? '#888888' : '#000000',
                  className: schedule.is_completed ? 'line-through' : ''
                };
              });
              successCallback(events);
            })
            .catch(error => {
              console.error('ì¼ì • ë¡œë“œ ì˜¤ë¥˜:', error);
              failureCallback(error);
            });
        },
        eventClick: function(info) {
          // ì¼ì • ìƒì„¸ ë³´ê¸° (dashboard.htmlê³¼ ë™ì¼)
          document.getElementById('detailTitle').textContent = info.event.title;
          document.getElementById('detailTime').textContent = new Date(info.event.start).toLocaleString('ko-KR') + 
                                                            ' - ' + 
                                                            new Date(info.event.end).toLocaleString('ko-KR');
          document.getElementById('detailDesc').textContent = info.event.extendedProps.description || '(ì—†ìŒ)';
          document.getElementById('detailPriority').textContent = info.event.extendedProps.priority;
          document.getElementById('detailCompleted').textContent = info.event.extendedProps.is_completed ? 'ì™„ë£Œ' : 'ë¯¸ì™„ë£Œ';
          
          // ìˆ˜ì • ë° ì‚­ì œ ë²„íŠ¼ì— ì´ë²¤íŠ¸ ID ì„¤ì •
          document.getElementById('completeBtn').dataset.id = info.event.id;
          document.getElementById('deleteBtn').dataset.id = info.event.id;
          
          // ì™„ë£Œ ìƒíƒœì— ë”°ë¼ ì™„ë£Œ ë²„íŠ¼ í‘œì‹œ ì—¬ë¶€
          document.getElementById('completeBtn').style.display = info.event.extendedProps.is_completed ? 'none' : 'block';
          
          // ëª¨ë‹¬ í‘œì‹œ
          document.getElementById('detailModal').classList.remove('hidden');
        },
        dateClick: function(info) {
          // ë‚ ì§œ í´ë¦­ ì‹œ ëŒ€ì‹œë³´ë“œë¡œ ì´ë™í•˜ì—¬ ì¼ì • ì¶”ê°€ í¼ì— ë‚ ì§œ ì„¤ì •
          const clickedDate = new Date(info.date);
          const formattedDate = clickedDate.toISOString().slice(0, 16);
          
          // í´ë¦­í•œ ë‚ ì§œë¥¼ localStorageì— ì €ì¥
          localStorage.setItem('selectedDate', formattedDate);
          
          // ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ë¡œ ì´ë™
          window.location.href = '/dashboard';
        }
      });
      calendar.render();
      
      // ì „ì—­ ë³€ìˆ˜ë¡œ ìº˜ë¦°ë” ì €ì¥
      window.calendar = calendar;
    }
    
    // ìš°ì„ ìˆœìœ„ì— ë”°ë¥¸ ìƒ‰ìƒ ë°˜í™˜ í•¨ìˆ˜ (dashboard.htmlê³¼ ë™ì¼)
    function getPriorityColor(priority) {
      const colors = {
        1: '#CCCCCC',  // íšŒìƒ‰
        2: '#63B3ED',  // íŒŒë€ìƒ‰
        3: '#7F9CF5',  // ì¸ë””ê³ 
        4: '#F6E05E',  // ë…¸ë€ìƒ‰
        5: '#F56565'   // ë¹¨ê°„ìƒ‰
      };
      return colors[priority] || '#7F9CF5';
    }
    
    // ìš°ì„ ìˆœìœ„ ë°°ì§€ ë°˜í™˜ í•¨ìˆ˜ (dashboard.htmlê³¼ ë™ì¼)
    function getPriorityBadge(priority) {
      const colors = {
        1: 'bg-gray-200 text-gray-700',
        2: 'bg-blue-100 text-blue-700',
        3: 'bg-indigo-100 text-indigo-700',
        4: 'bg-yellow-100 text-yellow-700',
        5: 'bg-red-100 text-red-700'
      };
      
      return `<span class="ml-2 text-xs px-2 py-0.5 rounded-full ${colors[priority]}">P${priority}</span>`;
    }
    
    // ì˜¤ëŠ˜ì˜ ì¼ì • ë¡œë“œ í•¨ìˆ˜ (ìƒˆë¡œ ì¶”ê°€ëœ í•¨ìˆ˜)
    async function loadTodaySchedules() {
      try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const tomorrow = new Date(today);
        tomorrow.setDate(tomorrow.getDate() + 1);
        
        const schedules = await fetchAPI('/api/schedules');
        const todaySchedules = schedules.filter(schedule => {
          const scheduleDate = new Date(schedule.start_time);
          return scheduleDate >= today && scheduleDate < tomorrow;
        });
        
        const container = document.getElementById('today-schedules-container');
        
        if (todaySchedules.length === 0) {
          container.innerHTML = '<div class="text-center py-3">ì˜¤ëŠ˜ ì˜ˆì •ëœ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }
        
        // ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
        todaySchedules.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
        
        let html = '<div class="space-y-2 max-h-[300px] overflow-y-auto pr-2">';
        
        todaySchedules.forEach(schedule => {
          const startTime = new Date(schedule.start_time).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
          const endTime = new Date(schedule.end_time).toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});
          const priorityBadge = getPriorityBadge(schedule.priority);
          const completedClass = schedule.is_completed ? 'line-through' : '';
          const bgColor = schedule.is_completed ? 'bg-gray-50' : '';
          
          html += `
            <div class="border rounded-lg p-4 flex justify-between items-start hover:bg-gray-50 ${bgColor}">
              <div>
                <h5 class="font-semibold ${completedClass}">${schedule.title} ${priorityBadge}</h5>
                <p class="text-sm text-gray-600">${startTime} - ${endTime}</p>
                <p class="text-sm text-gray-500">${schedule.description || ''}</p>
              </div>
              <div class="flex">
                <div class="mr-3">
                  <input class="mr-1" type="checkbox" 
                    ${schedule.is_completed ? 'checked' : ''} 
                    onchange="toggleScheduleComplete(${schedule.id}, this.checked)">
                  <label class="text-sm">ì™„ë£Œ</label>
                </div>
                <button class="text-sm bg-red-100 text-red-600 px-2 py-1 rounded hover:bg-red-200" 
                  onclick="deleteSchedule(${schedule.id})">ì‚­ì œ</button>
              </div>
            </div>
          `;
        });
        
        html += '</div>';
        container.innerHTML = html;
      } catch (error) {
        console.error('ì˜¤ëŠ˜ì˜ ì¼ì • ë¡œë“œ ì˜¤ë¥˜:', error);
        document.getElementById('today-schedules-container').innerHTML = 
          '<div class="bg-red-100 text-red-700 p-4 rounded">ì¼ì •ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
      }
    }
    
    // ì¼ì • ì™„ë£Œ ìƒíƒœ í† ê¸€ í•¨ìˆ˜ (dashboard.htmlê³¼ ë™ì¼)
    async function toggleScheduleComplete(id, isCompleted) {
      try {
        await fetchAPI(`/api/schedules/${id}`, 'PUT', {
          is_completed: isCompleted
        });
        
        // ì˜¤ëŠ˜ì˜ ì¼ì • ë‹¤ì‹œ ë¡œë“œ
        loadTodaySchedules();
        
        // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
        window.calendar.refetchEvents();
        
        // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
        document.getElementById('detailModal').classList.add('hidden');
      } catch (error) {
        alert(error.message || 'ì¼ì • ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
    
    // ì¼ì • ì‚­ì œ í•¨ìˆ˜ (dashboard.htmlê³¼ ë™ì¼)
    async function deleteSchedule(id) {
      if (!confirm('ì •ë§ ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }
      
      try {
        await fetchAPI(`/api/schedules/${id}`, 'DELETE');
        
        // ì˜¤ëŠ˜ì˜ ì¼ì • ë‹¤ì‹œ ë¡œë“œ
        loadTodaySchedules();
        
        // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨
        window.calendar.refetchEvents();
        
        // ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ë‹«ê¸°
        document.getElementById('detailModal').classList.add('hidden');
      } catch (error) {
        alert(error.message || 'ì¼ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    }
  </script>
</body>
</html>